"""Модуль для фильтрации нецензурной лексики"""
import re
import logging
from typing import List

logger = logging.getLogger(__name__)


class ProfanityFilter:
    """Класс для проверки сообщений на наличие нецензурной лексики"""
    
    def __init__(self):
        # Базовый список нецензурных слов и их вариаций
        # Список включает основные корни нецензурной лексики и распространенные варианты
        self.bad_words = [
            # Основные корни (4 основных + расширенный список)
            'хуй', 'хуя', 'хуе', 'хую', 'хуё', 'хуев', 'хуйня', 'хуйню', 'хуйней',
            'пизда', 'пизде', 'пизды', 'пизду', 'пиздой', 'пиздить', 'пиздишь', 'пиздил',
            'ебал', 'ебать', 'ебет', 'ебу', 'ебаный', 'ебанный', 'ебаная', 'ебаную',
            'бля', 'блядь', 'бляди', 'блядский', 'блядство', 'блядский', 'блядям',
            # Дополнительные грубые выражения
            'жопа', 'жопой', 'жопе', 'жопу', 'жопы', 'жопный',
            'гандон', 'гондон', 'гандона', 'гондона',
            'мудак', 'мудака', 'мудаки', 'мудацкий',
            'шлюха', 'шлюхи', 'шлюхой',
            # Вариации с заменой букв (для обхода фильтров)
            # Примечание: слова с заменой букв обрабатываются автоматически через replacements
            'хyй', 'пizда', 'ебaть', 'блaдь',
            # Производные и грубые выражения
            'еблан', 'еблана', 'ебланы',
            'заебись', 'заебал', 'заебать', 'заебись',
            'уебок', 'уебка', 'уебки',
            'ебануть', 'ебанулся', 'ебанулся',
            'выебать', 'выебал', 'выебала',
            'отъебись', 'отъебитесь',
            'похуй', 'похуист', 'похуиста',
            'нахуй', 'нахрен', 'нахер',
            'сука', 'суки', 'сукой', 'сукин',
            'сучка', 'сучки', 'сучкой',
            'гад', 'гады', 'гадом',
            'мразь', 'мрази',
            'падла', 'падлы',
            'тварь', 'твари',
            'ублюдок', 'ублюдки',
            'дебил', 'дебила', 'дебилы', 'дебильный',
            'идиот', 'идиота', 'идиоты', 'идиотский',
            'дурак', 'дурака', 'дураки', 'дурацкий',
            'кретин', 'кретина', 'кретины',
            'тупой', 'тупая', 'тупые', 'тупость',
            'лох', 'лоха', 'лохи',
            'долбоеб', 'долбоеба', 'долбоебы',
            'пидор', 'пидора', 'пидоры', 'пидорский',
            'педик', 'педика', 'педики',
            'гомик', 'гомика', 'гомики',
            # Грубые выражения и фразы
            'иди нахуй', 'иди нахрен', 'иди в жопу',
            'пошел нахуй', 'пошел нахрен',
            'заткнись', 'заткни ебало',
            'завали ебало',
            # Вариации с пробелами и символами
            'х у й', 'п и з д а', 'е б а т ь',
            'х-у-й', 'п-и-з-д-а',
            'х.у.й', 'п.и.з.д.а',
        ]
        
        # Компиляция регулярных выражений для более гибкой проверки
        self.patterns = []
        self._compile_patterns()
    
    def _compile_patterns(self):
        """Компиляция паттернов для поиска нецензурной лексики"""
        # Паттерны для обхода фильтров (замена букв на похожие символы)
        replacements = {
            'а': '[аa@]',
            'о': '[оo0]',
            'е': '[еe]',
            'и': '[иi1]',
            'с': '[сc]',
            'р': '[рp]',
            'у': '[уy]',
            'х': '[хx]',
        }
        
        for word in self.bad_words:
            # Пропускаем слова со специальными символами для регулярных выражений
            # Они будут проверяться простым поиском подстроки
            special_chars = ['*', '+', '?', '^', '$', '[', ']', '(', ')', '{', '}', '|', '\\']
            if any(char in word for char in special_chars):
                continue
            
            pattern = word.lower()
            
            # Сначала заменяем буквы на паттерны с альтернативами
            for char, replacement in replacements.items():
                pattern = pattern.replace(char, replacement)
            
            # Экранируем все символы, кроме тех, что уже в квадратных скобках
            # Разбиваем на части: паттерны [аa@] и обычные символы
            result_parts = []
            i = 0
            while i < len(pattern):
                if pattern[i] == '[':
                    # Находим закрывающую скобку паттерна
                    end = pattern.find(']', i)
                    if end != -1:
                        result_parts.append(pattern[i:end+1])
                        i = end + 1
                    else:
                        result_parts.append(re.escape(pattern[i]))
                        i += 1
                else:
                    # Экранируем обычные символы
                    result_parts.append(re.escape(pattern[i]))
                    i += 1
            
            # Добавляем возможность вставки пробелов между символами
            # Но только если есть более одного элемента
            if len(result_parts) > 1:
                pattern = r'\s*'.join(result_parts)
            else:
                pattern = ''.join(result_parts)
            
            try:
                compiled_pattern = re.compile(pattern, re.IGNORECASE)
                self.patterns.append(compiled_pattern)
            except re.error as e:
                logger.warning(f"Ошибка компиляции паттерна для слова '{word}' (паттерн: '{pattern}'): {e}")
                continue
    
    def contains_profanity(self, text: str) -> bool:
        """
        Проверка текста на наличие нецензурной лексики
        
        Args:
            text: Текст для проверки
            
        Returns:
            True если найдена нецензурная лексика, False иначе
        """
        if not text:
            return False
        
        text_lower = text.lower()
        
        # Простая проверка по списку слов
        for word in self.bad_words:
            if word.lower() in text_lower:
                logger.debug(f"Найдено запрещенное слово: {word}")
                return True
        
        # Проверка по регулярным выражениям
        for pattern in self.patterns:
            if pattern.search(text):
                logger.debug(f"Найдено запрещенное слово по паттерну: {pattern.pattern}")
                return True
        
        return False
    
    def add_word(self, word: str):
        """Добавление нового слова в список запрещенных"""
        if word not in self.bad_words:
            self.bad_words.append(word.lower())
            self._compile_patterns()
            logger.info(f"Добавлено новое запрещенное слово: {word}")
    
    def remove_word(self, word: str):
        """Удаление слова из списка запрещенных"""
        if word.lower() in self.bad_words:
            self.bad_words.remove(word.lower())
            self._compile_patterns()
            logger.info(f"Удалено запрещенное слово: {word}")

